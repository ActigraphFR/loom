TRANSITMAP_BIN := ../build/transitmap
OPTIM := comb
CORE_GRAPH := 1
SPLITTING_OPTIM := 1

PARAMS := --render-stations=1 --render-node-fronts=0
RPARAMS := --outline-width=0 --render-edges=0 --render-station-names=0 --render-node-fronts=0 --splitting-optim=${SPLITTING_OPTIM} --optim-method=${OPTIM} --create-core-optim-graph=${CORE_GRAPH} --render-dir-markers=1 --ilp-time-limit=1200


%/network.svg: %/network.json
	cat $< | $(TRANSITMAP_BIN) -o $@ $(PARAMS) --splitting-optim=${SPLITTING_OPTIM} --optim-method=${OPTIM} --create-core-optim-graph=${CORE_GRAPH} | sed '/stats/w $(dir $<)/stats'

zittau_map/%: %/network.json
	mkdir -p $@
	mkdir -p $@/export/
	mkdir -p $@/z16/
	mkdir -p $@/z15/
	mkdir -p $@/z14/
	mkdir -p $@/z13/
	mkdir -p $@/z12/
	mkdir -p $@/z11/

	cp $< $@/export/

	# the reference used for download
	cat $< | $(TRANSITMAP_BIN) --outline-width=3 --line-width=15 --line-spacing=4 --station-label-textsize=60 --ilp-time-limit=1200 --line-label-textsize=60 -o $@/export/network.svg --render-labels=1 --render-dir-markers=1 --render-stats=1 --mps-output-path=$@/export/network.mps --world-file-path=$@/export/  --resolution=0.1 $(EXTBINARY) --splitting-optim=${SPLITTING_OPTIM} --name=$(shell basename $@ | tr /a-z/ /A-Z/) --optim-method=${OPTIM} --create-core-optim-graph=${CORE_GRAPH}
	inkscape $@/export/network.svg  --export-pdf=$@/export/network.pdf

	# z16
	# cat $< | $(TRANSITMAP_BIN) $(RPARAMS) --render-engine=svg_sep --line-width=10 --line-spacing=5 -o $@/z16/ --world-file-path=$@/z16/network_e.pngw  --resolution=0.5
	# cp $@/z16/network_e.pngw $@/z16/network_s.pngw
	# cp $@/z16/network_e.pngw $@/z16/network_n.pngw
	# inkscape $@/z16/edges.svg --export-area-snap --export-png=$@/z16/network_e.png
	# inkscape $@/z16/nodes.svg --export-area-snap --export-png=$@/z16/network_n.png
	# inkscape $@/z16/stations.svg --export-area-snap --export-png=$@/z16/network_s.png
	# python scripts/gdal2tilesp.py -w none -z 16 -s EPSG:4326 $@/z16/network_e.png $@/edges
	# python scripts/gdal2tilesp.py -w none -z 16 -s EPSG:4326 $@/z16/network_s.png $@/stations
	# python scripts/gdal2tilesp.py -w none -z 16 -s EPSG:4326 $@/z16/network_n.png $@/nodes

	# z15
	cat $< | $(TRANSITMAP_BIN) $(RPARAMS) --render-engine=svg_sep --station-label-textsize=60 --line-label-textsize=60 --line-width=15 --line-spacing=4 -o $@/z15/ --world-file-path=$@/z15/network_e.pngw  --resolution=0.22
	cp $@/z15/network_e.pngw $@/z15/network_s.pngw
	cp $@/z15/network_e.pngw $@/z15/network_n.pngw
	cp $@/z15/network_e.pngw $@/z15/network_l.pngw
	inkscape $@/z15/edges.svg --export-area-snap --export-png=$@/z15/network_e.png
	inkscape $@/z15/nodes.svg --export-area-snap --export-png=$@/z15/network_n.png
	inkscape $@/z15/stations.svg --export-area-snap --export-png=$@/z15/network_s.png
	inkscape $@/z15/labels.svg --export-area-snap --export-png=$@/z15/network_l.png
	python scripts/gdal2tilesp.py -w none -z 15 -s EPSG:4326 $@/z15/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 15 -s EPSG:4326 $@/z15/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 15 -s EPSG:4326 $@/z15/network_n.png $@/nodes
	python scripts/gdal2tilesp.py -w none -z 15 -s EPSG:4326 $@/z15/network_l.png $@/labels


	# z14
	cat $< | $(TRANSITMAP_BIN) $(RPARAMS) --render-engine=svg_sep --station-label-textsize=100 --line-label-textsize=100 --line-width=22 --line-spacing=4 -o $@/z14/ --world-file-path=$@/z14/network_e.pngw  --resolution=0.125
	cp $@/z14/network_e.pngw $@/z14/network_s.pngw
	cp $@/z14/network_e.pngw $@/z14/network_n.pngw
	cp $@/z14/network_e.pngw $@/z14/network_l.pngw
	inkscape $@/z14/edges.svg --export-area-snap --export-png=$@/z14/network_e.png
	inkscape $@/z14/nodes.svg --export-area-snap --export-png=$@/z14/network_n.png
	inkscape $@/z14/stations.svg --export-area-snap --export-png=$@/z14/network_s.png
	inkscape $@/z14/labels.svg --export-area-snap --export-png=$@/z14/network_l.png
	python scripts/gdal2tilesp.py -w none -z 14 -s EPSG:4326 $@/z14/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 14 -s EPSG:4326 $@/z14/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 14 -s EPSG:4326 $@/z14/network_n.png $@/nodes
	python scripts/gdal2tilesp.py -w none -z 14 -s EPSG:4326 $@/z14/network_l.png $@/labels


	# z13
	cat $< | $(TRANSITMAP_BIN) $(RPARAMS) --render-engine=svg_sep --station-label-textsize=200 --line-label-textsize=200 --line-width=38 --line-spacing=5 -o $@/z13/ --world-file-path=$@/z13/network_e.pngw  --resolution=0.075
	cp $@/z13/network_e.pngw $@/z13/network_s.pngw
	cp $@/z13/network_e.pngw $@/z13/network_n.pngw
	cp $@/z13/network_e.pngw $@/z13/network_l.pngw
	inkscape $@/z13/edges.svg --export-area-snap --export-png=$@/z13/network_e.png
	inkscape $@/z13/nodes.svg --export-area-snap --export-png=$@/z13/network_n.png
	inkscape $@/z13/stations.svg --export-area-snap --export-png=$@/z13/network_s.png
	inkscape $@/z13/labels.svg --export-area-snap --export-png=$@/z13/network_l.png
	python scripts/gdal2tilesp.py -w none -z 13 -s EPSG:4326 $@/z13/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 13 -s EPSG:4326 $@/z13/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 13 -s EPSG:4326 $@/z13/network_n.png $@/nodes
	python scripts/gdal2tilesp.py -w none -z 13 -s EPSG:4326 $@/z13/network_l.png $@/labels


	# z12
	cat $< | $(TRANSITMAP_BIN) $(RPARAMS) --render-engine=svg_sep --station-label-textsize=400 --line-label-textsize=400 --line-width=52 --line-spacing=5 -o $@/z12/ --world-file-path=$@/z12/network_e.pngw  --resolution=0.03
	cp $@/z12/network_e.pngw $@/z12/network_s.pngw
	cp $@/z12/network_e.pngw $@/z12/network_n.pngw
	cp $@/z12/network_e.pngw $@/z12/network_l.pngw
	inkscape $@/z12/edges.svg --export-area-snap --export-png=$@/z12/network_e.png
	inkscape $@/z12/nodes.svg --export-area-snap --export-png=$@/z12/network_n.png
	inkscape $@/z12/stations.svg --export-area-snap --export-png=$@/z12/network_s.png
	inkscape $@/z12/labels.svg --export-area-snap --export-png=$@/z12/network_l.png
	python scripts/gdal2tilesp.py -w none -z 12 -s EPSG:4326 $@/z12/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 12 -s EPSG:4326 $@/z12/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 12 -s EPSG:4326 $@/z12/network_n.png $@/nodes
	python scripts/gdal2tilesp.py -w none -z 12 -s EPSG:4326 $@/z12/network_l.png $@/labels


	# z11
	cat $< | $(TRANSITMAP_BIN) $(RPARAMS) --render-engine=svg_sep --station-label-textsize=600 --line-label-textsize=600 --line-width=64 --line-spacing=3 -o $@/z11/ --world-file-path=$@/z11/network_e.pngw  --resolution=0.015
	cp $@/z11/network_e.pngw $@/z11/network_s.pngw
	cp $@/z11/network_e.pngw $@/z11/network_n.pngw
	cp $@/z11/network_e.pngw $@/z11/network_l.pngw
	inkscape $@/z11/edges.svg --export-area-snap --export-png=$@/z11/network_e.png
	inkscape $@/z11/nodes.svg --export-area-snap --export-png=$@/z11/network_n.png
	inkscape $@/z11/stations.svg --export-area-snap --export-png=$@/z11/network_s.png

	# something is not right with multi-zoomlevel tile generationin parallel version, create them separately
	python scripts/gdal2tilesp.py -w none -z 11 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 11 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 11 -s EPSG:4326 $@/z11/network_n.png $@/nodes

	python scripts/gdal2tilesp.py -w none -z 10 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 10 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 10 -s EPSG:4326 $@/z11/network_n.png $@/nodes

	python scripts/gdal2tilesp.py -w none -z 9 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 9 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 9 -s EPSG:4326 $@/z11/network_n.png $@/nodes

	python scripts/gdal2tilesp.py -w none -z 8 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 8 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 8 -s EPSG:4326 $@/z11/network_n.png $@/nodes

	python scripts/gdal2tilesp.py -w none -z 7 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 7 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 7 -s EPSG:4326 $@/z11/network_n.png $@/nodes

	python scripts/gdal2tilesp.py -w none -z 6 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 6 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 6 -s EPSG:4326 $@/z11/network_n.png $@/nodes

	python scripts/gdal2tilesp.py -w none -z 5 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 5 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 5 -s EPSG:4326 $@/z11/network_n.png $@/nodes

	python scripts/gdal2tilesp.py -w none -z 4 -s EPSG:4326 $@/z11/network_e.png $@/edges
	python scripts/gdal2tilesp.py -w none -z 4 -s EPSG:4326 $@/z11/network_s.png $@/stations
	python scripts/gdal2tilesp.py -w none -z 4 -s EPSG:4326 $@/z11/network_n.png $@/nodes
